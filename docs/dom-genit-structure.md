# Genit DOM Structure Snapshot

Captured: browser console export (`GMH.Core` adapter) – 50 sequential message blocks.

| Index | Message ID | Role (`data-gmh-message-role`) | Resolved Role | Primary Classes | Content Sample (truncated) |
| ----- | ---------- | ----------------------------- | ------------- | --------------- | -------------------------- |
| 0 | 0f048b15-160a-4fb5-906a-cd21c468234e | `npc` | npc | `space-y-3 mb-6` | 햇살이 눈부시게 쏟아지는… |
| 1 | 2bdf5b29-5c00-4f22-9586-ade914f0ba4c | `player` | player | `space-y-3 mb-6` | 나는 영문을 모르는 상황에서… |
| 2 | d4fd674e-bc59-4e5d-85a5-0f3cc86414c4 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 마치 벼락이라도… |
| 3 | a861faa6-7c47-4fee-b0cd-d8b55f076cbd | `player` | player | `space-y-3 mb-6` | ' |
| 4 | d9d2324f-99c6-4fb1-8b7a-4836f7400871 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이윤서의 날카로운… |
| 5 | 75d1bc0b-f3ef-495f-b209-b4753a666c06 | `player` | player | `space-y-3 mb-6` | 💭 상황 분석, 나는 지금… |
| 6 | 1897b2c4-4acf-475d-99f0-b35feff12c2c | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 무기가 없다는 사실에… |
| 7 | cd4afd0c-cd63-4f4f-9ef9-8aa4095e5131 | `player` | player | `space-y-3 mb-6` | 💭 전제조건 달성… |
| 8 | 9c45ccf6-1a93-4d25-8f3f-00bde78dc958 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299의 입에서 나온 말에… |
| 9 | 2ed5a710-b19e-42b2-af9d-db248e402825 | `player` | player | `space-y-3 mb-6` | 💭 먼저 특이점 파악 및 기록… |
| 10 | 75d1bc0b-f3ef-495f-b209-b4753a666c06 | `npc` | npc | `space-y-3 mb-6` | 이윤서의 쌍검이 번개처럼… |
| 11 | 1897b2c4-4acf-475d-99f0-b35feff12c2c | `player` | player | `space-y-3 mb-6` | 💭 특이점 파악 및 분석… |
| 12 | cd4afd0c-cd63-4f4f-9ef9-8aa4095e5131 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이윤서가 다음 공격을… |
| 13 | 9c45ccf6-1a93-4d25-8f3f-00bde78dc958 | `player` | player | `space-y-3 mb-6` | 판단 |
| 14 | 2ed5a710-b19e-42b2-af9d-db248e402825 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 바닥에 제압된… |
| 15 | 75d1bc0b-f3ef-495f-b209-b4753a666c06 | `player` | player | `space-y-3 mb-6` | 💭 주요 맥락 파악… |
| 16 | 1897b2c4-4acf-475d-99f0-b35feff12c2c | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 미동도 하지 않았다… |
| 17 | cd4afd0c-cd63-4f4f-9ef9-8aa4095e5131 | `player` | player | `space-y-3 mb-6` | 💭 상황 분석… |
| 18 | 9c45ccf6-1a93-4d25-8f3f-00bde78dc958 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이윤서가 숙고에… |
| 19 | 2ed5a710-b19e-42b2-af9d-db248e402825 | `player` | player | `space-y-3 mb-6` | 💭 단순 휴리스틱 모델로… |
| 20 | 75d1bc0b-f3ef-495f-b209-b4753a666c06 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 깊은 숨을… |
| 21 | 1897b2c4-4acf-475d-99f0-b35feff12c2c | `player` | player | `space-y-3 mb-6` | 네, 이윤서님도, 감사합니다… |
| 22 | cd4afd0c-cd63-4f4f-9ef9-8aa4095e5131 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이윤서를 향해 작게… |
| 23 | 9c45ccf6-1a93-4d25-8f3f-00bde78dc958 | `player` | player | `space-y-3 mb-6` | 아, 어떤 부분이요 공주님? |
| 24 | 2ed5a710-b19e-42b2-af9d-db248e402825 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 공주의 칭찬에… |
| 25 | 75d1bc0b-f3ef-495f-b209-b4753a666c06 | `player` | player | `space-y-3 mb-6` | 아... 음... 솔직하게 저도… |
| 26 | 1897b2c4-4acf-475d-99f0-b35feff12c2c | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 쑥스러운 듯… |
| 27 | cd4afd0c-cd63-4f4f-9ef9-8aa4095e5131 | `player` | player | `space-y-3 mb-6` | 음..... 공주님. 사실 지금… |
| 28 | 9c45ccf6-1a93-4d25-8f3f-00bde78dc958 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 주위를 한번 둘러봤다… |
| 29 | 2ed5a710-b19e-42b2-af9d-db248e402825 | `player` | player | `space-y-3 mb-6` | 집무실로 이서연 공주와 함께… |
| 30 | 75d1bc0b-f3ef-495f-b209-b4753a666c06 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이서연 공주와 함께… |
| 31 | 1897b2c4-4acf-475d-99f0-b35feff12c2c | `player` | player | `space-y-3 mb-6` | 아..... 굉장히 집무실이… |
| 32 | cd4afd0c-cd63-4f4f-9ef9-8aa4095e5131 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 집무실을 한 번… |
| 33 | 9c45ccf6-1a93-4d25-8f3f-00bde78dc958 | `player` | player | `space-y-3 mb-6` | 네, 괜찮아요. 걱정해주셔서… |
| 34 | 2ed5a710-b19e-42b2-af9d-db248e402825 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이서연 공주의… |
| 35 | 75d1bc0b-f3ef-495f-b209-b4753a666c06 | `player` | player | `space-y-3 mb-6` | 음...... 불편한 곳은 없어요… |
| 36 | 1897b2c4-4acf-475d-99f0-b35feff12c2c | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이서연 공주의 질문에… |
| 37 | cd4afd0c-cd63-4f4f-9ef9-8aa4095e5131 | `player` | player | `space-y-3 mb-6` | 음... 이유는 저도 잘... |
| 38 | 9c45ccf6-1a93-4d25-8f3f-00bde78dc958 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 자신이 왜 이런… |
| 39 | 2ed5a710-b19e-42b2-af9d-db248e402825 | `player` | player | `space-y-3 mb-6` | ...용사 후예..? 그게 무엇인가요? |
| 40 | 75d1bc0b-f3ef-495f-b209-b4753a666c06 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이서연 공주의 설명에… |
| 41 | 1897b2c4-4acf-475d-99f0-b35feff12c2c | `player` | player | `space-y-3 mb-6` | 아 그렇군요... 그럼 공주님은… |
| 42 | cd4afd0c-cd63-4f4f-9ef9-8aa4095e5131 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이서연 공주의 설명을… |
| 43 | 9c45ccf6-1a93-4d25-8f3f-00bde78dc958 | `player` | player | `space-y-3 mb-6` | 진심으로 그녀의 말에 감동받는다. |
| 44 | 2ed5a710-b19e-42b2-af9d-db248e402825 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이서연 공주의 설명을… |
| 45 | 75d1bc0b-f3ef-495f-b209-b4753a666c06 | `player` | player | `space-y-3 mb-6` | 진심으로 그녀에게 감동받는다. |
| 46 | 1897b2c4-4acf-475d-99f0-b35feff12c2c | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이서연 공주의 진심… |
| 47 | cd4afd0c-cd63-4f4f-9ef9-8aa4095e5131 | `player` | player | `space-y-3 mb-6` | 그런....정말 감사합니다 공주님... |
| 48 | 9c45ccf6-1a93-4d25-8f3f-00bde78dc958 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이서연 공주의 변함없는… |
| 49 | 2ed5a710-b19e-42b2-af9d-db248e402825 | `player` | player | `space-y-3 mb-6` | 고마워요... 그럼 이제... |
| 50 | 2ed5a710-b19e-42b2-af9d-db248e402825 | `npc` | npc | `space-y-3 mb-6` | 소중한코알라5299는 이서연 공주의 변함없는… |

> 모든 블록이 동일한 래퍼(`div.space-y-3.mb-6`)이며 텍스트는 `.markdown-content` 내부에 존재.

## Observations

- 현재 스냅샷에서는 **플레이어/NPC/나레이션 모두 동일한 래퍼 클래스**를 공유함 → 역할 판정은 내부 구조·텍스트 특성에 의존해야 함.
- 플레이어 메시지의 특징: `“나는…”, “💭”, “!”` 등 1인칭/내부 독백 스타일. 래퍼 자체는 DOM으로 구분 어려움.
- NPC(서술) 메시지는 장문 서술로 구성되며, 종종 나레이션과 구분이 모호함.
- 나레이션(예상 역할)은 `resolvedRole: npc`로 분류된 항목과 혼재되어 있음. 실제로는 서술이지만 NPC로 표기됨.
- 모든 항목에서 `resolvedRole`과 `roleAttr`가 일치 → 현재 어댑터의 `resolveBlockRole`이 DOM 구조만으로는 나레이션을 구분하지 못함.
- 추가 캡처(2024-xx)에서 확인된 사항: 모든 블록이 `data-gmh-message`, `data-gmh-message-index`, `data-gmh-message-id` 속성을 공유하며 `data-author-name` 등 화자 라벨 요소가 존재하지 않음. 내부 자식 태그는 `div`, `p`, `span`, `button`, `svg`, `pre`, `code` 등 공통 세트로 반복됨.
- NPC/서술 블록에는 `img`, `span`, `pre code`(코드 블록) 등이 함께 등장하지만 플레이어 블록에도 동일하게 나타날 수 있음 → 구조만으로 역할을 판정하기 어려움.
- `space-y-3 mb-6` 래퍼 내에서 `.markdown-content` 요소가 핵심 텍스트를 제공하며, 나레이션 후보 역시 동일한 경로에 위치.
- 2025-XX-XX 패치: 플레이어 행동/내적 독백이 회색 말풍선(`.p-3.rounded-lg.bg-muted/50`)이나 muted 텍스트(`.text-muted-foreground`)로 출력되어도 `playerText` 셀렉터가 수집하도록 보강했음. `emitPlayerLines`는 이제 플레이어 스코프 내부의 muted 텍스트는 허용하고, NPC/narration 범위 밖일 때만 필터링함.
- 여전히 오프닝 NPC/나레이션 섹션은 `playerTurn` 네이밍에 포함되지 않음 → 플레이어 턴 총합은 25가 정상. 향후 "오프닝 복수 블록 선택" 문제는 별도 이슈로 추적 필요.

## Action Items

1. **나레이션 탐지 기준 조정**  
   - 길이·서술 패턴(3인칭, 지문형)을 활용한 텍스트 휴리스틱 필요.
   - 또는 특정 안내 문구(“소중한코알라5299는…”) 등 반복 패턴을 기반으로 재분류.

2. **DOM 차별화 포인트 추가 조사**  
   - `.markdown-content` 내부에 hidden metadata 또는 icon이 있는지 추가 캡처 필요.

3. **유닛 테스트**  
    - 이 샘플을 fixture로 등록하고 파서/인덱서 일관성을 검증하는 테스트 작성 권장.

## Role Detection Notes (v1.3.7)

- **Player 스코프 신호**
  - `selectors.playerScopes`: `[data-role="user"]`, `[data-author-role="user"]`, `.flex.justify-end`, `.flex.flex-col.items-end` 등.
  - muted 말풍선(`.p-3.rounded-lg.bg-muted/50`, `.text-muted-foreground`)도 플레이어 범위 내에서 나타나면 `playerText`로 분류.
  - `data-gmh-player-turn` 속성이 붙으면 즉시 플레이어로 고정.
- **NPC/나레이션 구분**
  - `selectors.npcGroups`: `[data-role="assistant"]`, `.flex.flex-col.w-full.group`.
  - `selectors.narrationBlocks`: `.markdown-content.text-muted-foreground`, `.text-muted-foreground.text-sm`.
  - `emitPlayerLines`는 플레이어 스코프 외부의 나레이션/INFO 블록을 제외하지만, 동일 스코프 내부 muted 문구는 유지.
- **휴리스틱 요약**
  - tie-breaker는 요약된 스코어(`player`, `npc`, `narration`)를 계산해 동점 시 `narration → player → npc` 순으로 안전하게 떨어뜨림.
  - 회색/정렬 기반 플레이어 텍스트를 허용하면서도 NPC 말풍선(`selectors.npcBubble`)과 INFO(`selectors.infoCode`)는 계속 제외.
- **Known gap**
  - 오프닝/프롤로그와 같은 NPC 나레이션 블록은 여전히 플레이어 턴 총계에 포함되지 않으므로 UI 상한이 25에서 멈추는 사례가 있음. 별도 이슈로 추적 예정.
