# Changelog

## Unreleased

- _No changes yet_

## v1.7.1 (2025-10-04)

### 긴급 수정 (v1.7.0 False Positive 해결)

- **근접도 기반 감지 추가 (Phase 2)**: v1.7.0에서 발생한 일반 대화 오차단 문제를 해결했습니다.

  - **문제**: v1.7.0이 교육/상담 맥락이 아닌 모든 콘텐츠를 차단
    - 예: "17세 캐릭터 설정... (500자 후) ...성격이 활발함" → 잘못 차단됨
    - 사용자 피드백: "도저히 그런 기억이 없는데 차단됨"

  - **해결**: 100자 슬라이딩 윈도우로 키워드 근접도 검사
    - 미성년 키워드와 성적 키워드가 **100자 이내**에 있을 때만 차단
    - 멀리 떨어진 경우 자동 통과 처리

  - **결과**:
    - ✅ "17세 캐릭터...(500자)...성격" → 통과 (근접도 0)
    - ✅ "미성년자 보호법...(500자)...성적 소수자" → 통과 (근접도 0)
    - ✅ "미성년자 성교육" → 통과 (정당한 맥락, Phase 1)
    - ❌ "미성년자와 성관계" → 차단 (근접도 95)

### 기술 개선

- **근접도 계산 로직**: `calculateProximityScore()` 함수 추가
  - PROXIMITY_WINDOW = 100자
  - 임계값 = 70점 (거리가 가까울수록 높은 점수)

- **테스트 확대**: 원거리 vs 근접 시나리오 테스트 추가
  - "멀리 떨어진 키워드" 통과 검증
  - "가까운 키워드" 차단 검증

### 영향

- **False Positive 추가 감소**: 일반 대화/롤플레이에서 오탐 대폭 감소
- **사용자 경험 개선**: 정상적인 대화 내보내기가 원활해짐
- **Phase 1 유지**: 교육/상담/권리 맥락은 여전히 즉시 통과

### 참고

- Phase 3 (점수 기반 종합 평가)는 사용자 피드백 수집 후 결정 예정
- 1-2주 모니터링 기간 후 추가 개선 여부 평가

## v1.7.0 (2025-10-04)

### 프라이버시 보호 개선 (Phase 1)

- **미성년자 성적 맥락 감지 알고리즘 대폭 개선**: 정당한 교육/상담 콘텐츠와 위험 콘텐츠를 정확히 구분하는 새로운 감지 시스템을 도입했습니다.

  - **6가지 정당한 맥락 패턴 추가**: 학업 성적, 성교육, 성적 지향, 보호 활동, 권리 개념을 정확히 인식
    - 학업: "고등학생의 성적 향상", "성적 관리" 등
    - 성교육: "미성년자 성교육 프로그램", "성발달 상담" 등
    - 권리: "성적 자기결정권", "성적 건강" 등

  - **양방향 보호 패턴 매칭**: 키워드 순서에 관계없이 정당한 맥락 인식
    - ✅ "교육 프로그램: 미성년자 보호" (기존 방식)
    - ✅ "미성년자 성폭력 예방 캠페인" (새로 지원)

  - **명백한 위험 요소 감지**: 우회 시도를 효과적으로 차단
    - 범죄 키워드: 강간, 성폭행, 몰카, 아청법
    - 포르노 미디어: "야한 사진", "음란 영상" 등
    - 예: "미성년자 성교육 자료 야한 사진" → 차단 ✅

  - **조기 필터링 로직**: "정당한 맥락 + 위험 요소 없음 = 통과" 원칙 적용
    - 순수 교육 콘텐츠는 즉시 통과 처리
    - 위험 요소가 포함된 경우에만 차단

### 기술 개선

- **전역 정규식 상태 버그 수정**: `.test()` 호출 시 `lastIndex` 문제로 두 번째 호출부터 오작동하던 버그 수정
  - TEST용 정규식(`/i`)과 MATCH용 정규식(`/gi`)을 분리하여 상태 관리 문제 해결

- **테스트 가능성 향상**: 프라이버시 파이프라인에 `logger`/`storage` 주입 방식 도입
  - 디버그 모드 지원: `localStorage.setItem('gmh_debug_blocking', '1')`
  - 차단 결정 로그 출력으로 투명성 증대

- **테스트 커버리지 확대**: 새로운 감지 로직에 대한 포괄적인 테스트 추가
  - 정규식 상태 버그 회귀 방지 테스트
  - 정당한 교육/권리 콘텐츠 통과 검증
  - 우회 시도 차단 검증

### 개발 프로세스

- **AI 협업 리뷰 프로세스 도입**: Claude, Codex, Grok의 4차례 교차 리뷰를 통해 설계 검증
  - 기술적 정확성, 우회 가능성, 일관성 등 다각도 검토
  - `reviews/2025-10-04/` 폴더에 의사결정 과정 문서화

### 영향

- **False Positive 대폭 감소**: 교육/상담 콘텐츠에서 오탐 약 80% 감소 예상
- **보안 강화**: 교육 키워드를 악용한 우회 시도 차단
- **사용자 경험 개선**: 정당한 용도의 대화 내보내기가 더 원활해짐

## v1.6.4 (2025-10-01)

### 주요 버그 수정

- **NPC 블록 내 narration 누락 문제 해결**: NPC 대사와 narration이 같은 블록에 있을 때 narration이 export에서 완전히 누락되던 심각한 버그를 수정했습니다.
  - 원인: `markInfoNodeTree()`가 INFO 카드 마킹 시 상위 `.markdown-content` 전체를 INFO로 간주해, 같은 컨테이너의 narration `<p>` 태그도 걸러냄
  - 해결: INFO 카드(`.bg-card`, `.info-card`)만 선별적으로 마킹하도록 수정 (src/adapters/genit.js:405)

- **Narration-INFO 순서 문제 해결**: Narration이 DOM 순서와 다르게 INFO 카드보다 뒤에 배치되던 문제를 수정했습니다.
  - 원인: `emitInfo()`가 부모 `.markdown-content`를 `node`로 지정해, `getOrderPath()` 정렬 시 부모-자식 우선순위로 INFO가 먼저 옴
  - 해결: INFO 카드 wrapper(`.bg-card`)를 가리키도록 수정해 narration `<p>`와 형제 관계로 만들어 DOM 순서 유지 (src/adapters/genit.js:431-436)

### 성능 최적화 (Phase 1.5)

- **증분 스냅샷 캐싱**: DOM에 로드된 메시지만 파싱하도록 최적화해 대규모 대화에서 성능 개선
  - WeakMap 기반 블록 캐시로 재파싱 방지
  - `force: true` 플래그로 export 시 캐시 강제 갱신

- **자동 로더 캐싱 개선**: 스크롤 중 중복 파싱 방지 및 통계 계산 최적화

- **프라이버시 검증 강화**: 미성년자 콘텐츠 필터 및 레다크션 파이프라인 안정성 개선

### 문서 개선

- `docs/role-classification-heuristics.md`에 버그 수정 이력 및 DOM 구조 상세 기록 추가
- 핵심 교훈: "너무 넓은 범위를 가리켰다" - DOM 어댑터는 가능한 한 구체적이고 좁은 셀렉터 사용 필요

## npm run bump:patch  # v1.6.3
 - Fix: Markdown code fence rendering (Codex)
 - Fix: Duplicate line deduplication (Codex)
 - Test: Add regression tests for export accuracy

## v1.6.2 (2025-09-30)

- **Structured JSON 최적화**: 중복 데이터를 제거해 내보내기 파일 크기를 26% 축소했습니다.
  - 일반 part와 message에서 `legacyLines` 필드 제거 (INFO part는 폴백용으로 유지)
  - `meta.turn_range`를 `meta.selection`으로 통합하고 20개 중복 필드 제거
  - `selected_ordinals` 배열(중복값 100+ 항목) 완전 삭제
  - 프라이버시 파이프라인에서 legacy 데이터를 non-enumerable 속성으로 처리
- **테스트 커버리지 강화**: privacy-redaction 테스트를 Tampermonkey 의존성 없이 직접 모듈 단위 테스트로 재작성하고, structured-export 테스트에 fallback 시나리오 3개 추가했습니다 (총 58개 테스트 통과).
- **개발자 경험 개선**: JSON 구조가 단순해져 LLM 파싱 효율성과 디버깅 편의성이 향상되었습니다.

## v1.6.0 (2025-09-30)

- **모듈화 완료**: 7580줄 단일 파일을 46개 모듈(8개 디렉토리)로 분할해 유지보수성과 테스트 격리성을 대폭 개선했습니다.
- **Rollup 빌드 시스템 도입**: ESM 모듈을 Tampermonkey 호환 IIFE 단일 파일로 번들링하는 이중 빌드 시스템(`USE_ROLLUP=1` 플래그)을 구축했습니다.
- **아키텍처 구조**:
  - `src/core/`: 상태 관리, 에러 핸들링, 북마크, 메시지 인덱싱 등 핵심 모듈
  - `src/adapters/`: Genit 플랫폼 DOM 어댑터
  - `src/privacy/`: 프라이버시 프로필 및 레다크션 파이프라인
  - `src/export/`: JSON/Markdown/TXT 내보내기 및 파서
  - `src/ui/`: 패널, 모달, 설정 UI 컴포넌트
  - `src/features/`: 자동 로딩, 스냅샷, 가이드 프롬프트 등 기능 모듈
  - `src/utils/`: 텍스트 처리, DOM 유틸리티, 검증 함수
- **Legacy UI 분리**: Modern/Legacy 패널을 팩토리 패턴으로 분리해 조건부 렌더링 로직을 단순화했습니다.
- **테스트 안정성 유지**: 모듈화 과정에서 80개 테스트가 계속 통과하도록 점진적 마이그레이션을 수행했습니다.
- **개발자 경험 개선**: 명확한 디렉토리 구조와 의존성 주입 패턴으로 신규 기능 추가 및 디버깅이 용이해졌습니다.

## v1.5.0 (2025-10-04)

- 구조 보존 파이프라인을 재정비해 INFO 카드와 내레이션 라벨이 중복 수집되지 않도록 했습니다. INFO 블록은 한 번만 추출되고, 라벨 전용 텍스트(한 단어 이름)는 Rich/Classic 모두에서 자동으로 걸러집니다.
- DOM 순서를 기반으로 파트가 정렬되도록 수집기를 개선하고, Markdown/JSON 내보내기에서 INFO가 카드 위치에 맞춰 자연스럽게 표시되도록 정렬 로직을 추가했습니다.
- 새 `Rich TXT (.txt)` 내보내기 포맷을 도입해 메시지 헤더와 발화/코드/INFO 파트를 간결한 텍스트 기호로 표현합니다. Rich 모드 실패 시 Classic TXT로 자동 폴백합니다.
- Export 패널 기본값을 Rich Markdown으로 전환하고, README/역할 휴리스틱 문서를 새로운 Rich Markdown/TXT/JSON 흐름에 맞게 업데이트했습니다.
- 구조 보존 TXT/Markdown/JSON 생성 경로에 대한 Vitest 단위 테스트를 보강했습니다.

## v1.4.2 (2025-09-28)

- bookmark 클릭이 동일 messageId의 다른 DOM 노드를 참조하던 버그를 해결해, `시작/끝 지정`이 항상 최신 메시지 번호(1, 2 …)를 사용하도록 보강했습니다. ExportRange가 잘못된 6‒15 구간으로 스냅되는 현상이 사라집니다.
- ExportRange를 메시지 축 전용으로 정식 선언하고, 오디널 재계산/재선택 시 인덱서 캐시를 우선 사용하도록 정리했습니다.
- role heuristics 문서를 muted 플레이어 말풍선 포함 여부에 맞춰 업데이트하고, AGENTS.md/README.md를 현재 저장소 구조(테스트 폴더·Prettier 포함)에 맞게 정리했습니다. (`prettier`를devDependency로 추가)
- 관련 Vitest 스위트(`message-indexer`, `range-bookmark`, `export-range`)를 수동 실행해 리그레션을 확인했습니다.

## v1.4.0 (2025-09-28)

- 턴 파서를 플레이어/NPC/내레이션 축 대신 `user`/`llm` 메시지 축으로 리팩터링해 각 DOM 메시지가 고유한 순번(`data-gmh-message-ordinal`)을 갖도록 정비했습니다. JSON/Markdown/프리뷰 내보내기가 동일한 메시지 축을 사용합니다.
- 메시지 범위 지정 UI가 새 축을 기준으로 북마크·`시작지정/끝지정` 버튼을 동기화하면서 실험 플래그를 제거했습니다. 북마크 드롭다운은 최근 메시지 북마크 5개를 메시지 번호와 함께 표기합니다.
- README 및 역할 휴리스틱 문서를 업데이트해 메시지 축 변경과 범위 지정 기능이 정식으로 안정화되었음을 명시했습니다.

## v1.3.7 (2025-09-27)

- Genit 어댑터의 `playerText`/`emitPlayerLines` 필터를 보강해 회색 말풍선(`bg-muted/50`, `text-muted-foreground`)으로 표시되는 플레이어 행동·내적 독백이 JSON/Markdown 내보내기에 포함되도록 조정했습니다.
- `docs/dom-genit-structure.md`에 역할 판정 휴리스틱(플레이어/어시스턴트/내레이션 스코어링, muted 텍스트 처리)을 문서화하고, 오프닝 NPC 블록이 플레이어 턴 총계에 포함되지 않는 알려진 이슈를 기록했습니다.
- 나머지 플레이어 턴 총계는 25가 정상임을 명확히 하고, 오프닝 메시지 범위 선택 회귀는 후속 작업으로 분리했습니다.

## v1.3.5 (2025-09-26)

- ExportRange가 플레이어 턴 구간을 다시 산정하면서 NPC 응답이 누락되거나 범위 끝이 잘리는 회귀를 해결했습니다. 북마크 선택 → 범위 적용 → 내보내기 흐름에 대한 단위/통합 테스트를 추가해 회귀를 빠르게 감지합니다.
- 모달/프리뷰 요약을 문자열 `innerHTML` 삽입 대신 DOM API 조립 + 기본 정규화를 거치도록 바꿔 잠재적인 스크립트 삽입과 의도치 않은 마크업 주입을 차단했습니다.
- MutationObserver, 북마크 클릭 리스너의 start/stop 수명주기를 명시적으로 관리하고 페이지에서 벗어날 때 정리하도록 해 중복 등록과 잔류 상태를 방지했습니다.

## v1.3.2 (2025-09-26)

- Tampermonkey 메타헤더와 런타임 패널 배지가 모두 `package.json`의 버전을 참조하도록 버전 소스를 단일화했습니다. `GM_info`가 없을 때는 `GMH.VERSION`이 자동으로 `0.0.0-dev`를 노출해 개발 환경에서도 동작 상태를 확인할 수 있습니다.
- `npm run bump:patch|minor|major` 스크립트를 추가해 버전 업 → 메타데이터 동기화 → dist 빌드 → 태그 푸시까지 원클릭으로 수행하도록 릴리스 흐름을 정리했습니다.
- 플레이어 북마크 히스토리를 최대 5개까지 유지하고 ExportRange가 사용자 지정 시작/끝 값을 재설정하지 않도록 범위 계산 플로우를 보완했습니다. 관련 단위 테스트를 추가해 북마크 기반 범위 지정이 회귀하지 않도록 검증합니다.
- Genit DOM 어댑터가 플레이어/어시스턴트/내레이션 블록을 다시 분류하며, INFO·요약 블록이 플레이어 대사에 섞이지 않도록 셀렉터 필터를 강화했습니다.

## v1.3.0 (2025-09-26)

- Export 패널의 플레이어 턴 범위를 “최근 턴 = 1” 기준으로 재정의하고 `시작지정`/`끝지정` 북마크 버튼, 미리보기 강조, manifest 메타데이터를 연동해 부분 내보내기 워크플로를 개선했습니다. **북마크 버튼은 아직 실험 단계**로, 대화 맨 위/아래 메시지나 추가 스크롤 이후에는 값이 어긋날 수 있으며, 불안정한 동작은 다음 릴리스에서 우선적으로 보완할 예정입니다.
- README와 패널 툴팁에 범위 북마크 기능이 실험적이라는 경고를 추가해 사용자 기대치를 명시했습니다.
- Playwright mock 스모크 테스트에 패널 접힘/포커스/백그라운드 상호작용 케이스를 추가해 키보드 트랩 회귀를 방지했습니다.

## v1.2.1 (2025-09-25)

- 패널 단축키 포커스 예약을 정리해 ESC 이후 입력창 포커스 복원이 재차 끊기지 않도록 안정화
- Playwright 스모크 테스트가 헤드리스 환경에서도 안정적으로 통과하도록 클릭 프로브 위치와 스케줄링을 조정

## v1.2.0 (2025-09-25)

- 패널 상단 그립/하단 손잡이를 추가해 드래그 도킹과 리사이즈를 지원하고 위치·크기를 브라우저별로 기억하도록 개선
- 자동 접힘 시간·집중 모드·드래그/리사이즈 허용 여부를 ⚙ 설정 모달에서 즉시 토글할 수 있도록 UI를 확장
- 패널 포커스 복원, Collapse 시 클릭 스루 보장, `prefers-reduced-motion` 대응 등 접근성·키보드 UX를 강화
- Playwright 스모크 테스트에 접힘/포커스 회귀 케이스를 추가하고 Panel Settings 단위 테스트를 보강

## v1.1.0 (2025-09-25)

- 새 UI 패널/모달 체계를 기본값으로 활성화하고 킬스위치가 없을 때 자동으로 플래그를 재설정하도록 개선
- Stable/Beta 이중 채널을 단일 사용자 스크립트로 통합하고 베타 산출물/빌드 파이프라인을 정리
- README와 테스트를 업데이트해 설치 안내, 킬스위치 가이드, 단일 배포 흐름을 반영

## v1.0.0 (2025-09-26)

- GitHub Actions CI를 도입해 빌드·Vitest 단위 테스트·Playwright 스모크 테스트를 자동 실행하고 DOM 변화 감시 예약 스케줄을 추가
- Playwright 로그인 상태(global setup)와 세션/데모 이중 스모크 테스트를 추가해 테스트 계정·공개 데모 환경 모두에서 패널 동작을 검증
- Genit 홈 자산 해시를 기록하는 fingerprint 스크립트를 추가해 외부 DOM 업데이트 신호를 수집
- 태그 푸시 시 dist/genit-memory-helper.user.js를 빌드 후 GitHub Release에 업로드하는 자동 릴리스 파이프라인 구성
- Node 기반 build 스크립트 및 테스트 픽스처를 추가해 Tampermonkey 사용자 스크립트 산출물을 표준 dist 디렉터리에 생성

## v0.93 (2025-09-25)

- GMH 네임스페이스를 도입해 Core/Privacy/UI/Export 모듈을 분리하고 창 전역에 읽기 전용으로 노출
- Genit 전용 DOM 어댑터를 `GMH.Adapters.genit`으로 분리해 플랫폼 확장 스캐폴드를 마련
- 프라이버시 확인창을 미리보기 모달로 확장하고 자동 레다크션 샘플을 제공
- 상태 패널에 톤/아이콘 기반 피드백을 추가하고 “원클릭 내보내기(전체 로딩→내보내기)” 버튼을 지원

## v0.92 (2025-09-24)

- SAFE/STANDARD/RESEARCH 프라이버시 프로필과 자동 레다크션 파이프라인 추가
- 내보내기/복사 전 개인정보 확인창, 미성년자 성적 맥락 차단, 감사용 manifest 동시 저장
- 커스텀 블랙/화이트리스트 입력 및 패널 상태 메시지에 레다크션 요약 표기
- README/PRIVACY 문서에 보안 가이드라인 업데이트

## v0.91 (2025-09-23)

- 데이터 속성 우선 탐지 및 롤/텍스트 폴백으로 DOM 탐색 안정화 강화
- 자동 스크롤 프로파일(기본/안정/빠름)과 패널 재시도·스냅샷 버튼 추가
- 상태 메시지 전역화 및 DOM 스냅샷 다운로드 기능 도입

## v0.9 (2025-09-22)

- DOM 어댑터 레이어 추가로 셀렉터 의존 분리 및 텍스트 중심 파이프라인 강화
- 스크롤 컨테이너 탐지/패널 장착에 기능 기반 폴백과 옵저버 디바운스 적용
- README 업데이트: v0.9 변경 사항과 자동 스크롤 안정화 안내

## v0.8 (2025-09-21)

- 자동 스크롤 패널 추가: 끝까지 로딩 및 플레이어 턴 목표 확보 지원
- 플레이어 턴 기반 메타데이터 정리(턴 수/sceneId) 및 UI 문구 통일
- README 사용 지침과 사용자 패널 상태 메시지 업데이트

## v0.7 (2025-09-20)

- 대화 파서를 턴 기반 AST로 리팩터링하여 화자/내레이션 정규화 개선
- JSON/TXT/Markdown 3종 내보내기 및 최근 15턴/전체 MD 복사 액션 추가
- 요약/재요약 프롬프트 문구를 "로그 파일" 기준으로 정리

## v0.6 (2025-09-19)

- 요약 가이드 버튼 추가
- 재요약 가이드 버튼 추가
- 클립보드 복사 기능 개선

## v0.5 (2025-09-18)

- 역할 태깅(player|npc|narration) 안정화
- JSON 내보내기 기능 추가
- 메모리 블록 빌드 개선

## v0.4 (2025-09-18)

- INFO/씬 멀티 파싱 지원
- 대화 turns 배열 추가
- UI 패널 개선

## v0.3 (2025-09-18)

- 배우 카드, 기록코드 파싱 기능 추가

## v0.2 (2025-09-18)

- 기본 JSON 파싱 기능

## v0.1 (2025-09-18)

- 초기 버전: 기본 UI + 대화 로그 추출
